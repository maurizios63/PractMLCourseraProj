---
output: html_document
---
#Machine Learning: course project

#Author: Maurizio Spadari



## Introduction
This study analyzes the PML data set

##PData cleaning
The first step is to remove the columns that can not obviously used as a predictor. In this case the columns NOT related to sensor data are removed:

```{r,eval=TRUE,echo=TRUE}
library(caret)
trainDf <- read.csv2("../MLProject/pml-training.csv",sep=",")
drop <- c("user_name","raw_timestamp_part_1","raw_timestamp_part_2",
          "cvtd_timestamp","new_window","num_window")
trainDfR1 <- trainDf[,!(names(trainDf) %in% drop)]
```

The next step is to identify the columns that have at least N valid data in within
```{r,eval=TRUE,echo=TRUE,results="hide",warning=FALSE}
thr = 0.97
trainDfR2 <- as.data.frame(trainDfR1$classe)
names(trainDfR2)[1] <- "classe"
for (colName in names(trainDfR1[,!(names(trainDfR1) == "classe")])) {
  x <- as.numeric(as.character(trainDfR1[[colName]]))
  vld <- sum(is.finite(x))/length(trainDfR1[[colName]])
  
  if (vld > thr) {
    trainDfR2[,colName] <- x
  } else {
    cat(sprintf("Drop %s %f\n",colName,vld))
  }
}


```



Using rpart on train subDf
````{r,eval=TRUE,echo=TRUE}
inTrainRPart <- createDataPartition(y=trainDfR2[,1],p=0.9,list=FALSE)
trainSubDf <- trainDfR2[inTrainRPart,]
vldSubDf <- trainDfR2[-inTrainRPart,]
modFitRpart <- train(trainSubDf$classe~.,data=trainSubDf,method="rpart")
confusionMatrix(vldSubDf$classe,predict(modFitRpart,vldSubDf))

```

Using random forest
```{r,eval=FALSE,echo=TRUE}
inTrainRf <- createDataPartition(y=trainDfR2[,1],p=0.1,list=FALSE)
trainSubDf <- trainDfR2[inTrainRPart,]
vldSubDf <- trainDfR2[-inTrainRPart,]
modFit <- train(classe~.,data=trainPc,method="rf")

```

Principal component analysis is used to reduce variable
````{r,eval=FALSE,echo=TRUE}
preproc <- preProcess(trainSubDf[,-1],method="pca",thresh=0.85)
trainPc <- predict(preproc,trainSubDf[,-1])
modFit <- train(trainSubDf[,1]~.,data=trainPc,method="rf")

```

Cross Validation on test set

```{r,eval=FALSE,echo=TRUE}
vldSubDf <- trainDfR2[-inTrain,]
vldPc <- predict(preproc,vldSubDf[,-1])
confusionMatrix(vldSubDf[,1],predict(modFit,vldPc))
testDf <- read.csv2("../MLProject/pml-testing.csv",sep=",")

```


Evaluation on test set
```{r,eval=FALSE,echo=FALSE}
testDf <- read.csv2("../MLProject/pml-testing.csv",sep=",")
testDfR1 <- subset(testDf,select = colnames(trainDfR2)[-1])
for (colName in names(testDfR1)) {
  testDfR1[[colName]] <- as.numeric(as.character(testDfR1[[colName]]))
}
#expTest <- predict(modFitRpart,testDfR1)
expPc <- predict(preproc,testDfR1)
expTest <- predict(modFit,expPc)
```


